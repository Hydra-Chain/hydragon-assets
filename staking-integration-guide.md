# Hydra Staking and Delegation integration Guide

## Get Started

Welcome to the Hydra Chain! This guide will help you integrate staking and delegation functionalities into your application. Hydra Chain is a Layer 1 blockchain designed to solve the blockchain trilemma with innovative consensus (HydraGon) and economic mechanisms.

### Core Components of HydraChain

The Hydra Core is built on two tightly integrated components:

1. Ethereum-Like Node:

- A blockchain node with Ethereum-compatible features, handling traditional blockchain tasks such as transaction validation, block creation, and network communication.
- Powered by the HydraGon consensus mechanism, a unique protocol designed for optimal scalability, security, and decentralization.

2. System Smart Contracts:

- Deployed at predefined addresses, these contracts form the backbone of Hydra's staking, delegation, and economic functionalities.
- They enable advanced features like dynamic reward calculations, vesting management, and delegation pools.

### Key System Contracts

The system contracts operate as extensions to the Hydra Core, interacting with the consensus layer to handle staking, delegation, and economic operations:

HydraChain: Manages validator operations, epochs, and BLS cryptographic functionality.
HydraStaking: Tracks validator stakes and distributes rewards.
HydraDelegation: Handles delegation pools, rewards, and commissions.
VestingManagerFactory: Enables users to create and manage vested positions.
RewardWallet: Automates reward distribution.

Refer to the [Hydra Contracts Repository Readme](https://github.com/Hydra-Chain/hydragon-core-contracts#readme) for an overview of all contracts and their functions‚Äã‚Äã.

## Key integration points

Hydra Chain provides developers with flexible options to integrate staking and delegation functionality into their applications. Depending on their use case, developers can choose from the following approaches:

### Running a Node (Becoming a Validator):

- By running their own validator node, developers can participate directly in the HydraGon consensus mechanism.
- Validators earn rewards for validating blocks and can set a commission rate to earn additional income from delegators who choose to delegate their HYDRA to the node.
- This is an excellent choice for platforms like exchanges that want to offer delegation services to their users while benefiting from the rewards and commissions generated by their validator node.

**Advantages:**

- Full control over staking operations and commissions.
- The ability to promote their validator node to users as a trusted staking option.

**Setup Guide:**
Refer to the [Hydra Node Setup Documentation](https://github.com/Hydra-Chain/hydragon-node#readme) to configure and run a validator node‚Äã‚Äã.

### Using an Existing Delegation Pool

- Developers can simplify integration by delegating their HYDRA to an existing validator's delegation pool.
- This option is ideal for developers who do not want the overhead of maintaining a validator node but still want to participate in staking rewards.

**Advantages**

- Low operational overhead.
- Easier and faster to integrate delegation functionality.

**How to Use:**
Jump to the [Delegation Functionality](#delegation-functionality) section for detailed instructions on how to delegate HYDRA to a validator's delegation pool.

### Providing User Choice for Delegation

- Developers can build applications that empower users to select a validator node of their choice for delegation.
- This option provides maximum flexibility to users, making it suitable for wallets or DeFi platforms that cater to diverse user preferences.

**Integration Approach**

- Query the list of available validators and their details (e.g., commission rate, total stake) using:
  - The HydraChain contract for validator registration details.
  - The HydraStaking contract for stake and reward information.
- Implement UI/UX elements to display validator options, including metrics like:
  - Validator uptime.
  - Delegation rewards.
  - Commission rates.
- Delegate HYDRA to the selected validator.

**Advantages**

- Appeals to users who want to make informed decisions about staking.
- Builds trust by providing transparency and control.

## Delegation Functionality

The delegation system in Hydra allows users to delegate their HYDRA tokens to validators, enabling them to earn staking rewards without running a validator node. This section explains how developers can integrate delegation functionality into their applications.

### How Delegation Works

#### Delegator Role:

Delegators are users who stake their HYDRA tokens by delegating them to a validator.  
By delegating, they participate in staking rewards without the need to run their own validator node.  
Delegators earn a share of the validator‚Äôs staking rewards, proportional to their staked balance.

#### Validator Role:

Validators maintain network security by validating transactions and creating new blocks.  
They earn rewards for these activities, which include both their self-staked amount and the delegators' stakes.  
Validators can set a commission rate, a percentage of the rewards earned from delegators‚Äô stakes, as their payment for providing the validation service.

#### Reward Distribution:

Rewards earned by the validator are split proportionally between the validator and delegators based on their respective stake balances.  
From the delegators‚Äô share of rewards, the validator‚Äôs commission is deducted and retained by the validator.

#### Key Features of Delegation:

**Flexibility**: Delegators can choose any active validator to delegate their stake.
**Liquidity Tokens**: Delegators receive liquid tokens representing their stake, which can be used in DeFi applications.
**Vesting**: Delegators can opt for vested positions to earn loyalty bonuses on their rewards.

#### Base Delegation

This section focuses on simple delegation without vesting and its associated mechanics.

##### How APR is Calculated

For base delegation, the final APR is calculated dynamically based on the Base APR and the Macro Factor.

**Formula:**
APR = Base APR √ó Macro Factor

Where:

**Base APR:** Fixed at 5% for simple delegation.  
**Macro Factor:** A multiplier dynamically adjusted based on market and network conditions, ranging from 0.125x to 1.75x.
Examples:

- Bearish Market (Macro Factor = 0.5x):
  APR = 5% √ó 0.5 = 2.5%

- Neutral Market (Macro Factor = 1.0x):
  APR = 5% √ó 1.0 = 5%

- Bullish Market (Macro Factor = 1.5x):
  APR = 5% √ó 1.5 = 7.5%

Note: No vesting bonuses or RSI bonuses are applied to simple delegation.

###### How to Delegate

To delegate tokens, use the delegate function in the HydraDelegation contract:

```solidity
function delegate(address staker) external payable;
```

Parameters:

- staker: The address of the validator to which the delegation is being made.

##### Liquid Tokens Distribution

Liquid tokens are distributed on a 1:1 basis with delegated tokens.  
These tokens represent the delegator‚Äôs stake and can be used in DeFi applications or held for additional benefits.  
Liquid tokens are burned when the delegation is withdrawn or undelegated.

##### Free Undelegate

Delegators can withdraw their HYDRA without penalties using the undelegate function in the HydraDelegation contract. Once initiated, the undelegated tokens enter a cooldown period before becoming available for withdrawal.

###### How to Undelegate

```solidity
function undelegate(address staker, uint256 amount) external;
```

Parameters:

- staker: The address of the validator from which the delegation is being removed.
- amount: The number of HYDRA tokens to undelegate.

**Timelock**:
After undelegation, the tokens are locked in a cooldown period defined by the network protocol.

##### Rewards Distribution

Rewards for simple delegation are automatically distributed at the end of each epoch. Delegators can claim their rewards immediately after distribution.

###### How to Claim Rewards

```solidity
function claimDelegatorReward(address staker) external;
```

Parameters:

- staker: The address of the validator for which rewards are being claimed.

#### Vested Delegation

This section explains the mechanics of vested delegation, where users lock their HYDRA for a specified duration to earn additional loyalty bonuses, higher rewards, and potentially RSI bonuses.

##### How APR is Calculated

The APR for vested delegation is calculated using the following formula:

```
APR = (Base APR + Vesting Bonus) √ó Macro Factor √ó RSI Bonus
```

Where:

- Base APR: Fixed at 5%, similar to base delegation.
- Vesting Bonus: A loyalty reward based on the vesting duration:

```
  Vesting Bonus = [0.15 √ó ùëõ] / 1.5
```

n is the vesting period in weeks.

- Macro Factor: A multiplier reflecting market and network conditions, ranging from 0.125x to 1.75x.

- RSI Bonus: A reward multiplier available during bearish market conditions to incentivize participation, with values from 1.0x to 1.5x depending on market RSI.

**Note**: The RSI bonus applies only if the vested position is opened during oversold conditions in the network

###### Minimum and Maximum Vesting Period

- Minimum Vesting Period: 1 week.
- Maximum Vesting Period: 52 weeks (1 year).

Vesting periods directly impact the Vesting Bonus. Longer vesting periods yield higher bonuses but also lock tokens for an extended duration.

###### APR Calculation Example

Base APR: 5%.
Vesting Period: 52 weeks (maximum).
Macro Factor: 1.75x (bullish market).
RSI Bonus: 1.5x (maximum bonus in oversold conditions).

```
Vesting Bonus = [0.15 √ó 52] / 1.5 ‚âà 21.78%
APR=(5%+21.78%)√ó1.75√ó1.5
APR ~ 70.3%
```

###### How to Delegate with Vesting

Before delegating with vesting, a Vesting Manager must be created for the user. The VestingManager contract is responsible for managing vested positions and rewards.
See [The Role of the VestingManager Contract](#the-role-of-the-vestingmanager-contract) for details on how to use this contract effectively.

1. Create a Vesting Manager
   To create a vesting manager, use the newVestingManager function in the VestingManagerFactory contract:

```solidity
function newVestingManager() external;
```

- Action: Call this function once per user to set up their Vesting Manager.
- Result: A new proxy contract is deployed for the user, allowing them to manage vested positions.

**Note:** Create a new VestingManager only if there is no existing Vesting Manager for the user suitable for the desired vested position. Learn how to properly use VestingManagers in [The Role of the VestingManager Contract](#the-role-of-the-vestingmanager-contract) section.

2. Delegate with Vesting

Once the Vesting Manager is created, use the openVestedDelegatePosition function in the Vesting Manager to lock HYDRA tokens for a specified duration:

```solidity
function openVestedDelegatePosition(address staker, uint256 durationWeeks) external payable;
```

**Parameters**:

- staker: The address of the validator to which the delegation is being made.
- durationWeeks: The number of weeks to lock tokens (minimum 1, maximum 52).
- Payable Amount: The number of HYDRA tokens being delegated, sent as msg.value.

##### Liquid Tokens Distribution for Vested Delegation

For vested delegation, liquid tokens are distributed with a decrease of 0.0133 (or 1.33%) per week of vesting, reflecting the locked nature of the delegation.

The decrease in liquid tokens is calculated as:

```
Decrease = (Delegated Tokens √ó Vesting Weeks √ó 133) / 10,000
```

Where:

- Delegated Tokens: The total amount of HYDRA being delegated.
- Vesting Weeks: The duration of the vesting period in weeks.
- 1.33% Weekly Reduction

##### Vested Undelegate

Delegators can withdraw HYDRA from vested positions early, but this incurs penalties based on the remaining vesting period.  
To undelegate from a vested position, use the cutVestedDelegatePosition function in the Vesting Manager. Early undelegation incurs penalties based on the remaining vesting period.

- Option 1: Using cutVestedDelegatePosition
  Before calling the cutVestedDelegatePosition function, the user must explicitly approve the liquid tokens for use by the Vesting Manager. Use the ERC-20 approve function to allow the Vesting Manager to handle the tokens.

```
function approve(address spender, uint256 amount) external;
```

After approval, use the cutVestedDelegatePosition function to undelegate:

```solidity
function cutVestedDelegatePosition(address staker, uint256 amount) external payable;
```

Parameters:

- staker: The validator from which the delegation is being removed.
- amount: The number of HYDRA tokens to undelegate.

- Option 2: Using cutVestedDelegatePositionWithPermit

To simplify the process, developers can use the cutVestedDelegatePositionWithPermit function, which eliminates the need for a separate approval transaction. This function integrates the approval step directly into the undelegation process using EIP-2612 permits.

```solidity
function cutVestedDelegatePositionWithPermit(
    address staker,
    uint256 amount,
    uint256 deadline,
    uint8 v,
    bytes32 r,
    bytes32 s
) external payable;
```

Parameters:

- staker: The validator from which the delegation is being removed.
- amount: The number of HYDRA tokens to undelegate.
- deadline: A timestamp indicating the expiry of the permit.
- v, r, s: The components of the permit signature.

**Penalties: **
Early withdrawals reduce the accrued Vesting Bonus proportionally to the time left in the vesting period.

##### Rewards Distribution

Rewards for vested delegation are distributed at the end of each epoch, same as in the base delegation.  
Loyalty bonuses and RSI bonuses are included in the distributed rewards.

###### How to Claim Rewards

Rewards for vested delegation are distributed at the end of each epoch. However, rewards mature only after the vesting duration has elapsed. For example, if the vesting duration is 52 weeks, rewards distributed in week 3 will be claimable only in (or after) week 55 (after 52 weeks).

To ensure accurate reward distribution, the balance at the time of the last claimed distribution (represented by the balanceChangeIndex) must also be provided. This is necessary because any balance changes during the position's activity affect the vesting manager's reward share relative to the entire pool.

To claim rewards, the user specifies the epoch up to which rewards should be claimed, ensuring that only matured rewards are processed.

Use the claimVestedPositionReward function in the VestingManager contract:

```solidity
function claimVestedPositionReward(
    address staker,
    uint256 epochNumber,
    uint256 balanceChangeIndex
) external payable;
```

Parameters:

- staker: The validator for which rewards are being claimed.
- epochNumber: The epoch up to which rewards are being claimed (inclusive). Only rewards that have matured (i.e., past the vesting duration) are claimable.
- balanceChangeIndex: The index of the recorded balance at the time of the `epochNumber` reward distribution.

#### The Role of the VestingManager Contract

The VestingManager contract is a critical component of the Hydra Chain's vested delegation system. It enables users to manage vested positions, rewards, and operations.

##### Key Design Principles of the VestingManager

- Controlled by the User Account:

For technical reasons, vested positions can only be created and managed by a dedicated Vesting Manager contract instance.  
The Vesting Manager is deployed by the user's account and operates under the user's control. Only the account that created the Vesting Manager can execute actions through it.

- One Position Per Validator Per Manager:

Each Vesting Manager can maintain only one active vested position for a given validator (staker).  
If a user wishes to create another vested position for the same validator, they must:

Deploy a new Vesting Manager.
OR  
Use an existing Vesting Manager that does not already have an unfinished position for the validator.

- Definition of Unfinished Positions:

A position is considered unfinished if:  
The vesting period is ongoing.  
The vesting period has ended, but there are unclaimed rewards.

- Multiple Validators:

A single Vesting Manager can simultaneously maintain multiple active positions for different validators.

- Operations Exclusively via Vesting Manager:

All operations related to vested delegation, such as creation, undelegation, and rewards claiming, must be executed through the specific Vesting Manager contract instance.
